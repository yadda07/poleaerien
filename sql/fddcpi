-- FUNCTION: rip_avg_nge.fddcpi2(text)

-- DROP FUNCTION IF EXISTS rip_avg_nge.fddcpi2(text);

CREATE OR REPLACE FUNCTION rip_avg_nge.fddcpi2(
	zasro text)
    RETURNS TABLE(gid_dc2 bigint, gid_dc bigint, gid integer, sro character varying, nro character varying, length double precision, cab_type character varying, cab_capa integer, cab_modulo bigint, isole character varying, date_modif timestamp with time zone, modif_par character varying, geom geometry, cab_nature character varying, commentaire character varying, collecte character varying, cb_etiquet character varying, fon character varying, projet character varying, "DCE" character varying, dist_type text, affectation character varying, posemode integer) 
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE PARALLEL UNSAFE
    ROWS 1000

AS $BODY$
BEGIN
    DROP TABLE IF EXISTS temp_infra;	
    CREATE TEMP TABLE temp_infra AS
    SELECT t0.gid_pt, t0.geom, t0.inf_type
    FROM rip_avg_nge.infra(zasro) t0;
    
    -- Création d'une table temporaire pour la collection des géométries
    DROP TABLE IF EXISTS temp_infra_collect;
    CREATE TEMP TABLE temp_infra_collect AS
    SELECT ST_Collect(t0.geom) AS geom_collected
    FROM temp_infra t0;

    DROP TABLE IF EXISTS temp_infra_points;
    CREATE TEMP TABLE temp_infra_points AS
    SELECT 
        t_pts.gid_pt,
        t_pts.geom,
        t_pts.inf_type
    FROM temp_infra t_pts
    WHERE t_pts.gid_pt LIKE 'chb_%' 
       OR t_pts.gid_pt LIKE 'pot_%'
       OR t_pts.gid_pt LIKE 'atr_%';
    
    DROP TABLE IF EXISTS temp_fdrca;    
    CREATE TEMP TABLE temp_fdrca AS
    SELECT 
        t1.gid, 
        t1.gid_dc, 
        t1.geom, 
        t1.sro, 
        t1.nro, 
        t1.cab_type, 
        t1.cab_capa, 
        t1.cab_modulo, 
        t1.isole, 
        t1.date_modif, 
        t1.modif_par,
        t1.cab_nature, 
        t1.commentaire, 
        t1.collecte, 
        t1.cb_etiquet, 
        t1.fon, 
        t1.projet, 
        t1."DCE", 
        t1.dist_type, 
        t1.affectation
    FROM rip_avg_nge.fdrca(zasro) t1;
    DELETE FROM temp_fdrca WHERE ST_Length(temp_fdrca.geom) < 0.2 OR temp_fdrca.geom IS NULL;
    
    RETURN QUERY
    WITH cable_selection AS (
        SELECT 
            t2.gid AS cable_gid, 
            t2.gid_dc,
            t2.geom AS cable_geom,
            t3.geom_collected
        FROM temp_fdrca AS t2
        CROSS JOIN temp_infra_collect AS t3
        WHERE ST_DWithin(t2.geom, t3.geom_collected, 0.2)
    ),
    snapped_cables AS (
        SELECT
            t4.cable_gid,
            t4.gid_dc,
            ST_Snap(t4.cable_geom, t4.geom_collected, 0.2) AS snapped_geom,
            t4.geom_collected
        FROM cable_selection AS t4
        WHERE ST_IsValid(t4.cable_geom) AND ST_Length(t4.cable_geom) > 0.2
    ),
    split_cables AS (
        SELECT
            t5.cable_gid,
            t5.gid_dc,
            (ST_Dump(ST_Split(t5.snapped_geom, t5.geom_collected))).geom AS split_geom
        FROM snapped_cables AS t5
    ),
    valid_split_cables AS (
        SELECT 
            t6.cable_gid,
            t6.gid_dc,
            t6.split_geom
        FROM split_cables t6
        WHERE ST_IsValid(t6.split_geom) AND ST_Length(t6.split_geom) > 0.2 
    ),
    unique_cables AS (
        SELECT DISTINCT ON (t7.gid_dc, t7.cable_gid, t7.split_geom)
            ROW_NUMBER() OVER (ORDER BY t7.gid_dc, t7.cable_gid) AS gid_dc2,
            t7.gid_dc,
            t7.cable_gid AS gid,
            t7.split_geom AS geom
        FROM valid_split_cables t7
    ),
    cable_endpoints AS (
        SELECT
            uc.gid_dc2,
            uc.gid_dc,
            uc.gid,
            uc.geom,
            ST_StartPoint(uc.geom) AS start_point,
            ST_EndPoint(uc.geom) AS end_point
        FROM unique_cables uc
    ),
    endpoint_infrastructure AS (
        SELECT
            ce.gid_dc2,
            ce.gid_dc,
            ce.gid,
            ce.geom,
            (SELECT ip1.gid_pt FROM temp_infra_points ip1 
             WHERE ST_DWithin(ce.start_point, ip1.geom, 0.2) 
             ORDER BY ST_Distance(ce.start_point, ip1.geom) LIMIT 1) AS start_infra,
            (SELECT ip2.gid_pt FROM temp_infra_points ip2 
             WHERE ST_DWithin(ce.end_point, ip2.geom, 0.2) 
             ORDER BY ST_Distance(ce.end_point, ip2.geom) LIMIT 1) AS end_infra,
            (SELECT ip1.inf_type FROM temp_infra_points ip1 
             WHERE ST_DWithin(ce.start_point, ip1.geom, 0.2) 
             ORDER BY ST_Distance(ce.start_point, ip1.geom) LIMIT 1) AS start_inf_type,
            (SELECT ip2.inf_type FROM temp_infra_points ip2 
             WHERE ST_DWithin(ce.end_point, ip2.geom, 0.2) 
             ORDER BY ST_Distance(ce.end_point, ip2.geom) LIMIT 1) AS end_inf_type
        FROM cable_endpoints ce
    ),
    posemode_determination AS (
        SELECT
            ei.gid_dc2,
            ei.gid_dc,
            ei.gid,
            ei.geom,
            ei.start_infra,
            ei.end_infra,
            ei.start_inf_type,
            ei.end_inf_type,
            CASE
                -- Façade (posemode = 2)
                WHEN (ei.start_infra LIKE 'atr_%' AND ei.start_inf_type = 'FAC') OR
                     (ei.end_infra LIKE 'atr_%' AND ei.end_inf_type = 'FAC') THEN 2
                
                -- Souterrain (posemode = 0)
                WHEN (ei.start_infra LIKE 'chb_%' AND ei.end_infra LIKE 'chb_%') THEN 0
                WHEN (ei.start_infra LIKE 'chb_%' AND ei.end_infra LIKE 'atr_%') OR 
                     (ei.start_infra LIKE 'atr_%' AND ei.end_infra LIKE 'chb_%') THEN 0
		
		        WHEN (ei.start_infra LIKE 'pot_%' AND ei.end_infra LIKE 'chb_%') OR
                     (ei.start_infra LIKE 'chb_%' AND ei.end_infra LIKE 'pot_%') THEN 0
		
                WHEN (ei.start_infra LIKE 'pot_%' AND ei.end_infra LIKE 'atr_%' AND ei.end_inf_type = 'ADR') OR
                     (ei.start_infra LIKE 'atr_%' AND ei.start_inf_type = 'ADR' AND ei.end_infra LIKE 'pot_%') THEN 0
                
                -- Aérien (posemode = 1)
                WHEN (ei.start_infra LIKE 'pot_%' AND ei.end_infra LIKE 'pot_%') THEN 1

                WHEN (ei.start_infra LIKE 'pot_%' AND ei.end_infra LIKE 'atr_%' AND ei.end_inf_type = 'IMM') OR
                     (ei.start_infra LIKE 'atr_%' AND ei.start_inf_type = 'IMM' AND ei.end_infra LIKE 'pot_%') THEN 1
                
                ELSE 4 --indefini DQE
            END AS posemode
        FROM endpoint_infrastructure ei
    ),
    results AS (
        SELECT 
            pd.gid_dc2,
            pd.gid_dc, 
            pd.gid, 
            t8.sro, 
            t8.nro, 
            ST_Length(pd.geom) AS length,
            t8.cab_type, 
            t8.cab_capa, 
            t8.cab_modulo,
            t8.isole, 
            t8.date_modif, 
            t8.modif_par,
            pd.geom::geometry(linestring, 2154) AS geom, 
            t8.cab_nature, 
            t8.commentaire, 
            t8.collecte, 
            t8.cb_etiquet, 
            t8.fon, 
            t8.projet, 
            t8."DCE", 
            t8.dist_type, 
            t8.affectation,
            COALESCE(pd.posemode, 0) AS posemode 
        FROM posemode_determination pd
        JOIN temp_fdrca AS t8 
            ON pd.gid = t8.gid 
            AND pd.gid_dc = t8.gid_dc
    )
    SELECT * FROM results;   

END;
$BODY$;

ALTER FUNCTION rip_avg_nge.fddcpi2(text)
    OWNER TO ownergrp_auvergne;

GRANT EXECUTE ON FUNCTION rip_avg_nge.fddcpi2(text) TO PUBLIC;

GRANT EXECUTE ON FUNCTION rip_avg_nge.fddcpi2(text) TO auvergne_sch_etudes WITH GRANT OPTION;

GRANT EXECUTE ON FUNCTION rip_avg_nge.fddcpi2(text) TO ownergrp_auvergne WITH GRANT OPTION;

GRANT EXECUTE ON FUNCTION rip_avg_nge.fddcpi2(text) TO sdupays;

COMMENT ON FUNCTION rip_avg_nge.fddcpi2(text)
    IS '
FDDCPI2 - Fonction Dynamique de Découpe des Câbles Préparés. Les câbles réduits préalablement traités par la fonction rip_avg_nge.FDRCA sont associés à l''infrastructure fournie par rip_avg_nge.infra(zasro). Cette fonction encapsule les résultats de ces deux opérations dans des tables temporaires pour un traitement contrôlé et fiable, garantissant l''exclusion des câbles dont la longueur est inférieure à 20 cm. 

La fonction détermine également le mode de pose des câbles :
- posemode = 0 : souterrain (entre chambres, ou  autres de type ADR/SHE)
- posemode = 1 : aérien (  poteaux  et autres de type IMM)
- posemode = 2 : façade (autres de type FAC)
';
