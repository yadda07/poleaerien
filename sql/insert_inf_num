-- FUNCTION: rip_avg_nge.insert_inf_num_pt_ac()

-- DROP FUNCTION IF EXISTS rip_avg_nge.insert_inf_num_pt_ac();

CREATE OR REPLACE FUNCTION rip_avg_nge.insert_inf_num_pt_ac()
    RETURNS trigger
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE NOT LEAKPROOF
AS $BODY$
DECLARE
    last_inf_num INTEGER;
    new_inf_num TEXT;
    code_insee TEXT;
BEGIN
    code_insee := (SELECT insee FROM rip_avg_nge.communes_auvergne WHERE ST_Intersects(geom, NEW.geom) LIMIT 1);
    RAISE NOTICE 'Code INSEE récupéré: %', code_insee;

    IF code_insee IS NOT NULL AND NEW.inf_num IS NULL AND NEW.inf_type = 'POT-AC' THEN
        SELECT MAX(CAST(split_part(inf_num,'/',1) AS INTEGER))
        INTO last_inf_num
        FROM (
            SELECT t1.inf_num 
            FROM rip_avg_nge.infra_pt_pot t1 
            JOIN rip_avg_nge.communes_auvergne c ON ST_Intersects(t1.geom, c.geom)
            WHERE c.insee_dep = (SELECT insee_dep FROM rip_avg_nge.communes_auvergne WHERE insee = code_insee LIMIT 1) 
              AND t1.inf_num ~ '^\d+/\d+$' 
              AND t1.inf_type = 'POT-AC'
            UNION ALL
            SELECT t2.inf_num 
            FROM "GC".infra_pt_pot t2 
            JOIN rip_avg_nge.communes_auvergne c ON ST_Intersects(t2.geom, c.geom)
            WHERE c.insee_dep = (SELECT insee_dep FROM rip_avg_nge.communes_auvergne WHERE insee = code_insee LIMIT 1) 
              AND t2.inf_num ~ '^\d+/\d+$' 
              AND t2.inf_type = 'POT-AC'
        ) AS combined;

        RAISE NOTICE 'Dernier inf_num pour code INSEE %: %', code_insee, last_inf_num;
		
        IF last_inf_num IS NULL THEN
            last_inf_num := 0;
            RAISE NOTICE 'Aucun inf_num existant trouvé, initialisation à 0';
        END IF;
        
        new_inf_num := LPAD((last_inf_num + 1)::text, 7, '0') || '/' || code_insee;
        NEW.inf_num := new_inf_num;
        
        RAISE NOTICE 'Nouveau inf_num assigné: %', NEW.inf_num;
    ELSE
        RAISE NOTICE 'Pas de code INSEE trouvé ou inf_type non approprié: %', NEW.inf_type;
    END IF;

    RETURN NEW;
END;
$BODY$;

ALTER FUNCTION rip_avg_nge.insert_inf_num_pt_ac()
    OWNER TO yadda;

GRANT EXECUTE ON FUNCTION rip_avg_nge.insert_inf_num_pt_ac() TO PUBLIC;

GRANT EXECUTE ON FUNCTION rip_avg_nge.insert_inf_num_pt_ac() TO auvergne_sch_etudes;

GRANT EXECUTE ON FUNCTION rip_avg_nge.insert_inf_num_pt_ac() TO sdupays;

GRANT EXECUTE ON FUNCTION rip_avg_nge.insert_inf_num_pt_ac() TO yadda;

